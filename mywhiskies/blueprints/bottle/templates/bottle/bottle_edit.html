{% extends "_base.html" %}

{% block app_content %}
  <main class="flex-shrink-0">
    <div class="container ps-0">

      <div class="row mt-4">
        <h3 class="mb-0" style="color:#696969;">{{ bottle.user.username }}'s Whiskies: Edit Bottle</h3>
        <h1>{{ bottle.name }}</h1>
      </div>
    </div>

    <hr />

    <div class="container">
      <form method="post" enctype="multipart/form-data">
        {{ form.csrf_token }}
        {{ form.remove_image_1 }}
        {{ form.remove_image_2 }}
        {{ form.remove_image_3 }}
        <div class="row">
          <div class="col ms-0 ps-0 me-4 pe-4">
            <div class="mb-3">
              {{ form.name.label(class="form-label") }}
              {% if form.name.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.name(class="form-control") }}
              {% if form.name.errors %}
                <ul class="errors">
                  {% for error in form.name.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.url.label(class="form-label") }}
              {% if form.url.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.url(class="form-control") }}
              {% if form.url.errors %}
                <ul class="errors">
                  {% for error in form.url.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.distilleries.label(class="form-label") }}
              {% if form.distilleries.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.distilleries() }}
              {% if form.distilleries.errors %}
                <ul class="errors">
                  {% for error in form.distilleries.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.bottler_id.label(class="form-label") }}
              {% if form.bottler_id.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.bottler_id(class="form-select") }}
              {% if form.bottler_id.errors %}
                <ul class="errors">
                  {% for error in form.bottler_id.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.type.label(class="form-label") }}
              {% if form.type.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.type(class="form-select") }}
              {% if form.type.errors %}
                <ul class="errors">
                  {% for error in form.type.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
                {{ form.size.label(class="form-label") }}
                {% if form.size.flags.required %}<span class="text-danger">*</span>{% endif %}
                {{ form.size(class="form-control") }}
                {% if form.size.errors %}
                  <ul class="errors">
                    {% for error in form.size.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.year_barrelled.label(class="form-label") }}
                {% if form.year_barrelled.flags.required %}<span class="text-danger">*</span>{% endif %}
                {{ form.year_barrelled(class="form-control") }}
                {% if form.year_barrelled.errors %}
                  <ul class="errors">
                    {% for error in form.year_barrelled.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            <div class="mb-3">
              {{ form.year_bottled.label(class="form-label") }}
              {% if form.year_bottled.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.year_bottled(class="form-control") }}
              {% if form.year_bottled.errors %}
                <ul class="errors">
                  {% for error in form.year_bottled.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.abv.label(class="form-label") }}
              {% if form.abv.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.abv(class="form-control") }}
              {% if form.abv.errors %}
                <ul class="errors">
                  {% for error in form.abv.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.description.label(class="form-label") }}
              {% if form.description.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.description(class="form-control") }}
              {% if form.description.errors %}
                <ul class="errors">
                  {% for error in form.description.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.personal_note.label(class="form-label") }}
              {% if form.personal_note.flags.required %}<span class="text-danger">*</span>{% endif %}
              <a tabindex="-1" href="" class="float-end pe-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-html="true" data-bs-title="<i class='bi bi-question-circle pe-1'></i> Personal Note" data-bs-content="<p>Anything entered into this field will only be visible to you when logged in.</p><p>Perhaps it's the location of the bottle (e.g. 'Main Cabinet' or 'Bedroom Closet'), for example. </p><p>Anything that is relevant to you, but wouldn't necessarily be relevant to others, could go here.</p>" onclick="return false;"><i class="bi bi-question-circle-fill"></i></a>
              {{ form.personal_note(class="form-control") }}
              {% if form.personal_note.errors %}
                {% for error in form.personal_note.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.stars.label(class="form-label") }}
              {% if form.stars.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.stars(class="form-select") }}
              {% if form.stars.errors %}
                <ul class="errors">
                  {% for error in form.stars.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.review.label(class="form-label") }}
              {% if form.review.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.review(class="form-control") }}
              {% if form.review.errors %}
                <ul class="errors">
                  {% for error in form.review.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>

            <div class="mt-3 pt-3">
              {{ form.submit(class="btn btn-primary") }}
            </div>
          </div>

          <div class="col">
            <div class="mb-3">
              {{ form.is_private(class="form-check-input") }}&nbsp;&nbsp;{{ form.is_private.label(class="form-label") }}
              <a tabindex="-1" href="" class="pe-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-html="true" data-bs-title="<i class='bi bi-question-circle pe-1'></i> Private Bottle" data-bs-content="If marked as a &quot;Private Bottle&quot;, this bottle will only show in your list when you're logged in.<br /><br />Other users will not be able to see it." onclick="return false;"><i class="bi bi-question-circle-fill"></i></a>
            </div>
            <div class="mb-3">
              {{ form.cost.label(class="form-label") }}
              {% if form.cost.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.cost(class="form-control") }}
              {% if form.cost.errors %}
                <ul class="errors">
                  {% for error in form.cost.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.date_purchased.label(class="form-label") }}
              {% if form.date_purchased.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.date_purchased(class="form-control") }}
              {% if form.date_purchased.errors %}
                <ul class="errors">
                  {% for error in form.date_purchased.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.date_opened.label(class="form-label") }}
              {% if form.date_opened.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.date_opened(class="form-control") }}
              {% if form.date_opened.errors %}
                <ul class="errors">
                  {% for error in form.date_opened.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.date_killed.label(class="form-label") }}
              {% if form.date_killed.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.date_killed(class="form-control") }}
              {% if form.date_killed.errors %}
                <ul class="errors">
                  {% for error in form.date_killed.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mt-2 pt-2">
              <hr />
            </div>

            <div class="mb-2 pb-2">
              Upload up to 3 images. Portrait-oriented images are preferred. <i class="bi bi-file-image"></i>
              <br />
              By uploading images I agree to the <a href="" data-bs-toggle="modal" data-bs-target="#exampleModal">Image Terms and Conditions.</a>
            </div>

            {% if bottle.image_count %}
              {% set num_images = bottle.image_count %}
            {% else %}
              {% set num_images = 0 %}
            {% endif %}

            {% if num_images %}
              <div class="mb-2 pb-2">
                <div class="container text-center">
                  <div class="row">
                    {% for n in range(1, bottle.image_count + 1) %}
                      <div class="col-4 ps-0 ms-0 bottle-images" id="bottle-image-{{ n }}">
                        <img alt="{{ bottle.name }}" title="{{ bottle.name }}" class="w-100" src="{{img_s3_url}}/{{ bottle.id }}_{{ n }}.png?r={{ ts }}" />
                        <br />
                        <button type="button" class="btn btn-danger btn-sm mt-2 remove-image" value="{{ n }}">Remove Image</button>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}

            <div class="mb-3 {% if num_images >= 1 %} d-none{% endif %}" id="upload-image-1">
              {{ form.bottle_image_1.label(class="form-label") }}
              {% if form.bottle_image_1.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.bottle_image_1(class="form-control") }}
              {% if form.bottle_image_1.errors %}
                <ul class="errors">
                  {% for error in form.bottle_image_1.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
            <div class="mb-3 {% if num_images >= 2 %} d-none{% endif %}" id="upload-image-2">
              <div class="col">
              {{ form.bottle_image_2.label(class="form-label") }}
              {% if form.bottle_image_2.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.bottle_image_2(class="form-control") }}
              {% if form.bottle_image_2.errors %}
                <ul class="errors">
                  {% for error in form.bottle_image_2.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
              </div>
            </div>
            <div class="mb-3 {% if num_images >= 3 %} d-none{% endif %}" id="upload-image-3">
              {{ form.bottle_image_3.label(class="form-label") }}
              {% if form.bottle_image_3.flags.required %}<span class="text-danger">*</span>{% endif %}
              {{ form.bottle_image_3(class="form-control") }}
              {% if form.bottle_image_3.errors %}
                <ul class="errors">
                  {% for error in form.bottle_image_3.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Image Terms and Conditions</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>The following rules will be strictly enforced in regard to uploaded images.</p>
          <ul>
            <li>You may only upload your own personal images. No copyrighted images are permitted.</li>
            <li>
              Only photos of whiskey bottles and/or whiskey glasses are permitted. Photos must <em>not</em> include any of the following:
              <ul>
                <li>Any individuals</li>
                <li>Any physical addresses or phone numbers</li>
                <li>Any text, such as links to other websites or any personal information</li>
              </ul>
            </li>
          </ul>
          <p>Any account found to violate these rules with any images will be terminated immediately.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close Window</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script type="text/javascript">
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))
  </script>

  <script type="text/javascript">
    $( document ).ready(function() {
      $("button.remove-image").on("click", function() {

        $("#remove_image_" + this.value).val("YES");
        $("#bottle-image-" + this.value).addClass("d-none");
        let how_many_are_showing = $("div.bottle-images:visible").length + 1;
        $("#upload-image-" + how_many_are_showing).removeClass("d-none");
      });
    });
  </script>
{% endblock %}
